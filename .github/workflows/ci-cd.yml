name: Deploy to Render

on:
  push:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    environment: staging
    steps:
      - name: Deploy to Render Staging
        env:
          RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
        run: |
          echo "üöÄ Deploying to STAGING..."
          curl -X POST "$RENDER_DEPLOY_HOOK_URL"
          echo "‚úÖ Staging deployment triggered!"

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - name: Deploy to Render Production
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          echo "üöÄ Deploying to PRODUCTION..."
          # SIMPLE VERSION - Just trigger a redeploy
          # This assumes you only have ONE service in your Render account
          curl -X POST "https://api.render.com/v1/services" \
            -H "Authorization: Bearer ${RENDER_API_KEY}" \
            -H "Content-Type: application/json" \
            | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4 \
            | xargs -I {} curl -X POST "https://api.render.com/v1/services/{}/deploys" \
                -H "Authorization: Bearer ${RENDER_API_KEY}" \
                -H "Content-Type: application/json" \
                -d '{"clearCache": "clear"}'
          echo "‚úÖ Production deployment triggered!"
      
      - name: Check if production is up
        env:
          PRODUCTION_URL: ${{ secrets.PRODUCTION_URL }}
        run: |
          echo "üîÑ Checking if production is healthy..."
          sleep 45
          curl -f ${PRODUCTION_URL} || echo "‚ö†Ô∏è Service might still be starting..."